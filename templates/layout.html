<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>{% block title %}CueX{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description"
        content="CueX – Showplanung, Rig-Setup und Cue-Verwaltung für Veranstaltungstechnik.">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- Custom Dark Theme -->
  <style>
    :root {
      --bg-body: #0f1114;
      --bg-navbar: #0b0d10;
      --bg-card: #171a1f;
      --border-muted: #262b33;
      --input-bg: #101217;
      --input-bg-focus: #14171d;
      --input-border: #30343b;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --text-main: #f8f9fa;
      --text-muted: #6c757d;
    }

    body { background-color: var(--bg-body); color: var(--text-main); }

    .page-wrapper { padding-top: 104px; padding-bottom: 40px; }

    .navbar-dark { background-color: var(--bg-navbar) !important; }

    .navbar-brand { display: flex; align-items: center; }
    .navbar-brand img { height: 64px; width: auto; }
    .navbar-brand span {
      font-weight: 600; letter-spacing: 0.03em; font-size: 1.1rem;
      margin-left: 0.8rem; white-space: nowrap;
    }

    .card {
      background-color: var(--bg-card);
      border-radius: 0.75rem;
      border: 1px solid var(--border-muted);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.7);
    }

    .card-header {
      background-color: transparent;
      border-bottom: 1px solid var(--border-muted);
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--text-main);
    }

    .form-control, .form-select, .form-control-sm, .form-select-sm {
      background-color: var(--input-bg);
      border-color: var(--input-border);
      color: var(--text-main);
    }

    .form-label { color: #e9ecef; font-weight: 500; }

    .form-control::placeholder, .form-select::placeholder { color: #9ca3af; }

    .form-control:focus, .form-select:focus {
      background-color: var(--input-bg-focus);
      border-color: var(--primary);
      color: var(--text-main);
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.35);
    }

    .btn-primary { background-color: var(--primary); border-color: var(--primary); }
    .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }

    .btn-outline-danger { border-width: 1px; }
    .list-group-item { border-color: var(--border-muted); }

    .show-list-card .list-group-item { background-color: #14171d; border-color: var(--border-muted); }
    .show-list-item + .show-list-item { border-top: 1px solid #262b33; }

    .show-title { color: var(--text-main); font-weight: 600; }
    .show-subtitle { color: #d6dde8; font-size: 0.9rem; }

    @media (max-width: 576px) {
      .page-wrapper { padding-top: 88px; }
      .navbar-brand span { font-size: 1rem; }
    }

    /* Kein sichtbarer Sprung beim Restore */
    html.preload body { opacity: 0; }

    /* Anchor/Cue unter fixed Navbar sichtbar */
    [id^="cue-"] { scroll-margin-top: 120px; }
  </style>

  <!-- Preload NUR, wenn wirklich Restore auf derselben Seite passiert -->
  <script>
    (function () {
      try {
        const KEY_SCROLL = 'la_scroll_y';
        const KEY_URL    = 'la_scroll_url';

        const hasScroll = sessionStorage.getItem(KEY_SCROLL);
        const sameUrl   = sessionStorage.getItem(KEY_URL) === location.pathname;

        if (hasScroll && sameUrl) {
          document.documentElement.classList.add('preload');
          if ('scrollRestoration' in history) history.scrollRestoration = 'manual';
          setTimeout(() => document.documentElement.classList.remove('preload'), 1500);
        }
      } catch (e) {}
    })();
  </script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark border-bottom border-secondary fixed-top"
     aria-label="Hauptnavigation">
  <div class="container-fluid px-4">
    <a class="navbar-brand" href="{{ url_for('show_overview') }}">
      <img src="{{ url_for('static', filename='staticimg/staticimglogo.png') }}" alt="LichtBlast Logo">
      <span>CueX</span>
    </a>
    <div class="ms-auto d-flex align-items-center">
      <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm ms-2">Logout</a>
    </div>
  </div>
</nav>

<main class="container-fluid page-wrapper px-4">
  {% block content %}{% endblock %}
</main>

<!-- Bootstrap JS -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous"
></script>

<!-- Stabiler Restore: Save + Move ↑/↓ (focus_cue) -->
<script>
(function () {
  const KEY_SCROLL = 'la_scroll_y';
  const KEY_URL    = 'la_scroll_url';
  const KEY_OPEN   = 'la_open_cue';
  const KEY_FOCUS  = 'la_focus_cue';
  const OFFSET_TOP = 110;

  const safeInt = (v) => {
    const n = parseInt(String(v ?? ''), 10);
    return Number.isFinite(n) ? n : 0;
  };

  const scrollToEl = (el) => {
    const top = el.getBoundingClientRect().top + window.pageYOffset - OFFSET_TOP;
    window.scrollTo(0, Math.max(top, 0));
  };

  const cleanup = () => {
    try { sessionStorage.removeItem(KEY_SCROLL); } catch (e) {}
    try { sessionStorage.removeItem(KEY_URL); } catch (e) {}
    try { sessionStorage.removeItem(KEY_FOCUS); } catch (e) {}
  };

  const reveal = () => document.documentElement.classList.remove('preload');

  // Vor jedem Submit: Scroll + URL speichern, offenes Cue merken, focus_cue merken
  document.addEventListener('submit', function (ev) {
    try {
      sessionStorage.setItem(KEY_SCROLL, String(window.scrollY || 0));
      sessionStorage.setItem(KEY_URL, location.pathname);

      const open = document.querySelector('.song-collapse.show');
      if (open && open.id) sessionStorage.setItem(KEY_OPEN, open.id);

      const form = ev.target;
      const focusInput = form?.querySelector?.('input[name="focus_cue"]');
      if (focusInput?.value) sessionStorage.setItem(KEY_FOCUS, focusInput.value);
    } catch (e) {}
  }, true);

  // Beim Öffnen eines Cue: merken
  document.addEventListener('shown.bs.collapse', function (e) {
    const el = e.target;
    if (el?.classList?.contains('song-collapse') && el.id) {
      try { sessionStorage.setItem(KEY_OPEN, el.id); } catch (e) {}
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    let scrollY = null, openId = null, focusId = null, sameUrl = false;

    try {
      scrollY = sessionStorage.getItem(KEY_SCROLL);
      openId  = sessionStorage.getItem(KEY_OPEN);
      focusId = sessionStorage.getItem(KEY_FOCUS);
      sameUrl = sessionStorage.getItem(KEY_URL) === location.pathname;
    } catch (e) {}

    if (scrollY === null || !sameUrl) {
      cleanup();
      reveal();
      return;
    }

    cleanup();

    // 1) Priorität: Move ↑/↓ => genau zum betroffenen Cue
    if (focusId) {
      const card = document.getElementById('cue-' + focusId);
      const collapse = document.getElementById('songCollapse' + focusId);

      if (collapse && window.bootstrap) {
        const c = bootstrap.Collapse.getOrCreateInstance(collapse, { toggle: false });
        let done = false;

        const finish = () => { if (done) return; done = true; reveal(); };

        collapse.addEventListener('shown.bs.collapse', function () {
          scrollToEl(card || collapse);
          requestAnimationFrame(finish);
        }, { once: true });

        c.show();

        setTimeout(() => {
          if (!done) {
            if (card) scrollToEl(card);
            else window.scrollTo(0, safeInt(scrollY));
            finish();
          }
        }, 450);

        return;
      }

      if (card) scrollToEl(card);
      else window.scrollTo(0, safeInt(scrollY));
      reveal();
      return;
    }

    // 2) Sonst: zuletzt geöffnetes Cue wieder öffnen + dahin scrollen
    if (openId && window.bootstrap) {
      const el = document.getElementById(openId);
      if (el) {
        const c = bootstrap.Collapse.getOrCreateInstance(el, { toggle: false });
        let done = false;

        const finish = () => { if (done) return; done = true; reveal(); };

        el.addEventListener('shown.bs.collapse', function () {
          scrollToEl(el);
          requestAnimationFrame(finish);
        }, { once: true });

        c.show();

        setTimeout(() => {
          if (!done) {
            window.scrollTo(0, safeInt(scrollY));
            finish();
          }
        }, 350);

        return;
      }
    }

    // 3) Fallback: ScrollY
    window.scrollTo(0, safeInt(scrollY));
    requestAnimationFrame(reveal);
  });
})();
</script>
</body>
</html>