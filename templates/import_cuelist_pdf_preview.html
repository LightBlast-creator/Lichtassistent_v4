{% extends "layout.html" %}
{% block title %}PDF-Import Vorschau{% endblock %}
{% block content %}
<div class="container mt-4">
  <a href="{{ url_for('show_detail', show_id=show.id, tab='songs') }}" class="btn btn-outline-light btn-sm mb-3">← Zurück</a>
  <h2 class="h5 mb-3">PDF-Import: Vorschau extrahierter Text</h2>
  <pre style="background:#23272b;color:#f8f9fa;padding:1em;border-radius:6px;max-height:40vh;overflow:auto;">{{ pdf_text }}</pre>
  <h5 class="mt-4">Erkannte Rollen:</h5>
  <ul>
    {% for role in roles %}
      <li>{{ role }}</li>
    {% endfor %}
  </ul>
  <h5 class="mt-4">Erkannte Cues:</h5>
  <form id="cuesForm" method="post" action="{{ url_for('import_cuelist_pdf_commit', show_id=show.id) }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div style="max-height:30vh;overflow:auto;">
      <table class="table table-dark table-sm">
        <thead><tr><th>Szene</th><th>Rolle</th><th>Text</th><th>Löschen</th></tr></thead>
        <tbody id="cuesTableBody">
          {% for cue in cues %}
            <tr {% if cue.uncertain %}style="background-color:#6c2323;" title="Unsicher erkannt"{% endif %}>
              <td><input type="text" name="scene" value="{{ cue.scene or '' }}" class="form-control form-control-sm"></td>
              <td><input type="text" name="role" value="{{ cue.role or '' }}" class="form-control form-control-sm"></td>
              <td><input type="text" name="text" value="{{ cue.text or '' }}" class="form-control form-control-sm"></td>
              <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">✕</button></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <textarea id="cues_json" name="cues_json" style="display:none;"></textarea>
    <button type="submit" class="btn btn-success mt-3">Cues übernehmen</button>
  </form>
  <script>
    document.getElementById('cuesForm').addEventListener('submit', function(e) {
      const rows = document.querySelectorAll('#cuesTableBody tr');
      const cues = [];
      rows.forEach(row => {
        const scene = row.querySelector('input[name="scene"]').value;
        const role = row.querySelector('input[name="role"]').value;
        const text = row.querySelector('input[name="text"]').value;
        if (scene || role || text) {
          cues.push({scene, role, text});
        }
      });
      document.getElementById('cues_json').value = JSON.stringify(cues);
    });
  </script>
  <div class="alert alert-info mt-3">Bitte prüfe, ob die Rollen/Cues korrekt erkannt wurden. Mit Klick auf "Cues übernehmen" werden sie als neue Szenen/Cues gespeichert.</div>
</div>
{% endblock %}